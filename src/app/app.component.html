<!-- Compact Layout with Theme Toggle -->
<div class="min-h-screen p-4">
  <!-- Progress Toast -->
  <app-modal-progress [isVisible]="modalVisible" [title]="modalTitle" [message]="modalMessage"
    [progress]="modalProgress" [mode]="modalMode" (cancelled)="onModalCancel()"></app-modal-progress>

  <div class="max-w-7xl mx-auto">
    <!-- Header - Compact -->
    <header class="flex items-center justify-between mb-4 pb-3 border-b border-[var(--border-color)]">
      <div class="flex items-center gap-3">
        <span class="text-xl">ğŸ›ï¸</span>
        <div>
          <h1 class="text-lg font-bold text-[var(--text-primary)]">SEFAZ-MA</h1>
          <p class="text-[10px] text-[var(--text-muted)]">Monitoramento Fiscal</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-[10px] text-[var(--text-muted)]">{{ statusProcessamento }}</span>
        <button (click)="atualizarDados()" class="btn btn-ghost btn-sm">ğŸ”„</button>
        <div (click)="toggleTheme()" class="theme-toggle" [class.dark]="isDarkMode" title="Alternar tema"></div>
      </div>
    </header>

    <!-- KPI Row - Compact -->
    <section class="grid grid-cols-3 gap-3 mb-4">
      <div *ngFor="let item of dashboard" class="kpi" [class.success]="item.STATUS === 'PROCESSADO'"
        [class.warning]="item.STATUS === 'PENDENTE'" [class.danger]="item.STATUS === 'MALHA_FINA'">
        <p class="kpi-label">{{ item.STATUS || 'PENDENTE' }}</p>
        <p class="kpi-value" [class.text-success]="item.STATUS === 'PROCESSADO'"
          [class.text-warning]="item.STATUS === 'PENDENTE'" [class.text-danger]="item.STATUS === 'MALHA_FINA'">
          {{ item.QTD | number }}
        </p>
        <p class="kpi-total">{{ item.TOTAL | currency:'BRL' }}</p>
      </div>
    </section>

    <!-- Form + Actions - Compact Single Line -->
    <section class="card p-3 mb-4">
      <div class="flex items-center gap-3 flex-wrap">
        <input [(ngModel)]="novaNota.chaveAcesso" class="input flex-1 min-w-[200px] mono"
          placeholder="Chave de Acesso (44 dÃ­gitos)" maxlength="44">
        <input [(ngModel)]="novaNota.numeroNota" class="input w-24" placeholder="NÃºmero">
        <input [(ngModel)]="novaNota.valorTotal" type="number" class="input w-28" placeholder="Valor">
        <button (click)="salvar()" class="btn btn-primary">ğŸ“¥ Receber</button>
        <div class="h-6 w-px bg-[var(--border-color)]"></div>
        <button (click)="executarProcessamentoEmLote()" [disabled]="processando" class="btn btn-accent"
          [class.opacity-50]="processando">
          <span *ngIf="processando" class="animate-spin">âš™ï¸</span>
          <span *ngIf="!processando">âš¡</span>
          {{ processando ? 'Processando...' : 'Batch' }}
        </button>
        <button (click)="gerarMassaTeste()" [disabled]="gerandoMassa" class="btn btn-ghost btn-sm">
          ğŸš€ {{ gerandoMassa ? '...' : 'Seed 5k' }}
        </button>
      </div>
    </section>

    <!-- Table - Compact with Max Height -->
    <section class="card overflow-hidden">
      <div class="p-3 border-b border-[var(--border-color)] flex justify-between items-center">
        <span class="text-xs font-semibold text-[var(--text-secondary)]">ğŸ“‹ {{ totalCarregado | number }} notas
          carregadas</span>
        <span *ngIf="hasMore" class="text-[10px] text-[var(--text-muted)]">+mais disponÃ­veis</span>
      </div>

      <div class="relative overflow-auto" style="max-height: calc(100vh - 320px);">
        <!-- Loading -->
        <div *ngIf="isLoading"
          class="absolute inset-0 bg-[var(--surface-primary)]/80 z-10 flex items-center justify-center">
          <div class="w-8 h-8 border-2 border-[var(--primary-500)] border-t-transparent rounded-full animate-spin">
          </div>
        </div>

        <table class="tbl">
          <thead class="sticky top-0">
            <tr>
              <th class="w-16">ID</th>
              <th>Chave</th>
              <th class="w-28">Valor</th>
              <th class="w-24">Data</th>
              <th class="w-28">Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let n of notas">
              <td class="mono">{{ n.id }}</td>
              <td class="mono">{{ n.chaveAcesso }}</td>
              <td class="font-semibold text-success">{{ n.valorTotal | currency:'BRL' }}</td>
              <td class="text-[var(--text-secondary)]">{{ n.dataEmissao | date:'dd/MM HH:mm' }}</td>
              <td>
                <span class="badge" [class.badge-warning]="n.status === 'PENDENTE'"
                  [class.badge-success]="n.status === 'PROCESSADO'" [class.badge-danger]="n.status === 'MALHA_FINA'">
                  {{ n.status }}
                </span>
              </td>
            </tr>
            <tr *ngIf="notas.length === 0 && !isLoading">
              <td colspan="5" class="p-6 text-center text-[var(--text-muted)]">
                ğŸ“­ Nenhuma nota. Clique em "Seed 5k" para gerar dados.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Load More -->
      <div *ngIf="notas.length > 0 && hasMore" class="p-3 border-t border-[var(--border-color)] text-center">
        <button (click)="carregarMais()" [disabled]="isLoadingMore" class="btn btn-ghost btn-sm">
          <span *ngIf="isLoadingMore" class="animate-spin">â³</span>
          {{ isLoadingMore ? 'Carregando...' : 'â†“ Carregar mais 100' }}
        </button>
      </div>
    </section>
  </div>
</div>

<!-- Toast Container -->
<div class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
  <div *ngFor="let t of toasts" class="pointer-events-auto card p-3 min-w-[250px] flex items-center gap-2 border-l-3"
    [class.border-l-emerald-500]="t.type === 'success'" [class.border-l-red-500]="t.type === 'error'"
    [class.border-l-blue-500]="t.type === 'info'">
    <span>{{ t.type === 'success' ? 'âœ…' : t.type === 'error' ? 'âŒ' : 'â„¹ï¸' }}</span>
    <p class="text-xs text-[var(--text-primary)]">{{ t.message }}</p>
  </div>
</div>