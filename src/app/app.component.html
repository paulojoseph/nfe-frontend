<!-- Premium Dark Theme Layout -->
<div class="min-h-screen p-6 md:p-8">

  <!-- Progress Toast -->
  <app-modal-progress [isVisible]="modalVisible" [title]="modalTitle" [message]="modalMessage"
    [progress]="modalProgress" [mode]="modalMode" (cancelled)="onModalCancel()">
  </app-modal-progress>

  <div class="max-w-7xl mx-auto">

    <!-- Header Hero -->
    <header class="header-hero">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="logo-badge mb-3">
            <span>üèõÔ∏è</span>
            <span>Governo do Estado</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-extrabold text-gradient mb-2">
            SEFAZ-MA
          </h1>
          <p class="text-[var(--text-secondary)] text-sm md:text-base">
            Sistema de Monitoramento e Processamento de Notas Fiscais Eletr√¥nicas
          </p>
        </div>
        <div class="flex items-center gap-3">
          <div class="text-right hidden md:block">
            <p class="text-xs text-[var(--text-muted)]">√öltima atualiza√ß√£o</p>
            <p class="text-sm font-medium text-[var(--text-secondary)]">{{ statusProcessamento || 'Aguardando...' }}</p>
          </div>
          <button (click)="atualizarDados()" class="btn btn-ghost">
            <span>üîÑ</span>
            Sincronizar
          </button>
        </div>
      </div>
    </header>

    <!-- KPI Dashboard -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div *ngFor="let item of dashboard; let i = index" class="kpi-card animate-fade-in-up"
        [class.success]="item.STATUS === 'PROCESSADO'" [class.warning]="item.STATUS === 'PENDENTE'"
        [class.danger]="item.STATUS === 'MALHA_FINA'" [style.animation-delay.ms]="i * 100">

        <div class="flex items-start justify-between">
          <div>
            <p class="kpi-label">{{ item.STATUS || 'PENDENTE' }}</p>
            <p class="kpi-value" [class.text-emerald-400]="item.STATUS === 'PROCESSADO'"
              [class.text-amber-400]="item.STATUS === 'PENDENTE'" [class.text-red-400]="item.STATUS === 'MALHA_FINA'">
              {{ item.QTD | number }}
            </p>
          </div>
          <div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl"
            [class.bg-emerald-500/20]="item.STATUS === 'PROCESSADO'"
            [class.bg-amber-500/20]="item.STATUS === 'PENDENTE'" [class.bg-red-500/20]="item.STATUS === 'MALHA_FINA'">
            <span *ngIf="item.STATUS === 'PROCESSADO'">‚úÖ</span>
            <span *ngIf="item.STATUS === 'PENDENTE'">‚è≥</span>
            <span *ngIf="item.STATUS === 'MALHA_FINA'">üö®</span>
          </div>
        </div>

        <p class="kpi-total">
          <span class="text-[var(--text-muted)]">Volume:</span>
          <span class="font-semibold text-[var(--text-primary)] ml-1">{{ item.TOTAL | currency:'BRL' }}</span>
        </p>
      </div>
    </section>

    <!-- Reception Card -->
    <section class="glass-card-solid mb-8 overflow-hidden">
      <!-- Card Header -->
      <div class="p-6 border-b border-[var(--border-color)]">
        <div class="flex items-center gap-3 mb-1">
          <span class="text-xl">üì°</span>
          <h2 class="text-lg font-bold text-[var(--text-primary)]">Recep√ß√£o de NFe</h2>
        </div>
        <p class="text-sm text-[var(--text-muted)]">Insira os dados da nota fiscal para processamento</p>
      </div>

      <!-- Form -->
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
          <div class="md:col-span-5">
            <label class="block text-xs font-semibold text-[var(--text-muted)] uppercase tracking-wide mb-2">
              Chave de Acesso
            </label>
            <input [(ngModel)]="novaNota.chaveAcesso" class="input w-full mono" placeholder="44 d√≠gitos" maxlength="44">
          </div>

          <div class="md:col-span-2">
            <label class="block text-xs font-semibold text-[var(--text-muted)] uppercase tracking-wide mb-2">
              N√∫mero
            </label>
            <input [(ngModel)]="novaNota.numeroNota" class="input w-full" placeholder="Ex: 1001">
          </div>

          <div class="md:col-span-3">
            <label class="block text-xs font-semibold text-[var(--text-muted)] uppercase tracking-wide mb-2">
              Valor Total
            </label>
            <input [(ngModel)]="novaNota.valorTotal" type="number" class="input w-full" placeholder="R$ 0,00">
          </div>

          <div class="md:col-span-2">
            <button (click)="salvar()" class="btn btn-primary w-full">
              <span>üì•</span>
              Receber
            </button>
          </div>
        </div>
      </div>

      <!-- Actions Bar -->
      <div
        class="p-4 bg-[rgba(0,0,0,0.2)] flex flex-wrap justify-between items-center gap-4 border-t border-[var(--border-color)]">
        <div class="flex items-center gap-2">
          <span class="text-sm text-[var(--text-muted)]">Processamento em lote:</span>
        </div>
        <button (click)="executarProcessamentoEmLote()" [disabled]="processando" [class.opacity-50]="processando"
          class="btn btn-accent glow-gold animate-pulse-glow">
          <span *ngIf="processando" class="animate-spin">‚öôÔ∏è</span>
          <span *ngIf="!processando">‚ö°</span>
          {{ processando ? 'Processando...' : 'Rodar Batch (Lote)' }}
        </button>
      </div>
    </section>

    <!-- Table Section -->
    <section class="glass-card-solid overflow-hidden">
      <!-- Table Header -->
      <div class="p-6 border-b border-[var(--border-color)] flex flex-wrap justify-between items-center gap-4">
        <div class="flex items-center gap-3">
          <span class="text-xl">üìã</span>
          <div>
            <h2 class="text-lg font-bold text-[var(--text-primary)]">Notas Fiscais</h2>
            <p class="text-xs text-[var(--text-muted)]">
              Mostrando {{ totalCarregado | number }} registros
            </p>
          </div>
        </div>

        <div class="flex gap-3">
          <button (click)="gerarMassaTeste()" [disabled]="gerandoMassa" class="btn btn-ghost text-sm">
            <span *ngIf="gerandoMassa" class="animate-spin">üé≤</span>
            <span *ngIf="!gerandoMassa">üöÄ</span>
            {{ gerandoMassa ? 'Gerando...' : 'Gerar Massa (5k)' }}
          </button>
        </div>
      </div>

      <!-- Table Container -->
      <div class="relative overflow-x-auto">
        <!-- Loading Overlay -->
        <div *ngIf="isLoading"
          class="absolute inset-0 bg-[var(--surface-primary)]/80 backdrop-blur-sm z-10 flex flex-col items-center justify-center">
          <div
            class="w-12 h-12 border-2 border-[var(--primary-500)] border-t-transparent rounded-full animate-spin mb-3">
          </div>
          <span class="text-sm text-[var(--text-secondary)] animate-pulse">Carregando dados...</span>
        </div>

        <table class="table-premium">
          <thead>
            <tr>
              <th class="w-20">ID</th>
              <th>Chave de Acesso</th>
              <th class="w-36">Valor</th>
              <th class="w-32">Emiss√£o</th>
              <th class="w-36">Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let n of notas; let i = index">
              <td class="mono-cell">{{ n.id }}</td>
              <td class="mono-cell">{{ n.chaveAcesso }}</td>
              <td class="font-semibold text-emerald-400">{{ n.valorTotal | currency:'BRL' }}</td>
              <td class="text-[var(--text-secondary)]">{{ n.dataEmissao | date:'dd/MM HH:mm' }}</td>
              <td>
                <span class="badge" [class.badge-warning]="n.status === 'PENDENTE'"
                  [class.badge-success]="n.status === 'PROCESSADO'" [class.badge-danger]="n.status === 'MALHA_FINA'">
                  <span *ngIf="n.status === 'PROCESSADO'">‚óè</span>
                  <span *ngIf="n.status === 'PENDENTE'">‚óê</span>
                  <span *ngIf="n.status === 'MALHA_FINA'">‚ö†</span>
                  {{ n.status }}
                </span>
              </td>
            </tr>
            <tr *ngIf="notas.length === 0 && !isLoading">
              <td colspan="5" class="p-12 text-center text-[var(--text-muted)]">
                <div class="text-4xl mb-3 opacity-50">üì≠</div>
                <p>Nenhuma nota fiscal encontrada na base.</p>
                <p class="text-sm mt-1">Clique em "Gerar Massa" para criar dados de teste.</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Load More -->
      <div *ngIf="notas.length > 0" class="load-more-container">
        <p class="load-more-text">
          {{ totalCarregado | number }} notas carregadas
          <span *ngIf="hasMore">‚Ä¢ Mais registros dispon√≠veis</span>
          <span *ngIf="!hasMore">‚Ä¢ Todos os registros carregados</span>
        </p>
        <button *ngIf="hasMore" (click)="carregarMais()" [disabled]="isLoadingMore" class="btn btn-primary">
          <span *ngIf="isLoadingMore" class="animate-spin">‚è≥</span>
          <span *ngIf="!isLoadingMore">üì•</span>
          {{ isLoadingMore ? 'Carregando...' : 'Carregar Mais' }}
        </button>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mt-8 text-center text-xs text-[var(--text-muted)]">
      <p>SEFAZ-MA ‚Ä¢ Sistema de Monitoramento Fiscal ‚Ä¢ {{ 'now' | date:'yyyy' }}</p>
    </footer>

  </div>
</div>

<!-- Toast Container -->
<div class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 pointer-events-none">
  <div *ngFor="let t of toasts"
    class="pointer-events-auto glass-card-solid p-4 min-w-[300px] flex items-center gap-3 animate-fade-in-up"
    [class.border-l-4]="true" [class.border-l-emerald-500]="t.type === 'success'"
    [class.border-l-red-500]="t.type === 'error'" [class.border-l-blue-500]="t.type === 'info'">
    <span class="text-xl">
      {{ t.type === 'success' ? '‚úÖ' : t.type === 'error' ? '‚ùå' : '‚ÑπÔ∏è' }}
    </span>
    <p class="font-medium text-sm text-[var(--text-primary)]">{{ t.message }}</p>
  </div>
</div>